<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Sign Test - USDT Transaction</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/font-awesome.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 800px;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }
        .info-card {
            background: rgba(255, 255, 255, 0.95);
            border-left: 5px solid #0d6efd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- Header -->
        <div class="card">
            <div class="card-header">
                <h1 class="mb-0"><i class="fas fa-coins"></i> TRON Sign Test</h1>
                <p class="mb-0 mt-2" style="opacity: 0.9;">Тест подписи транзакций USDT (TRC-20)</p>
            </div>
            <div class="card-body">
                <div class="info-card">
                    <h5><i class="fas fa-info-circle"></i> Инструкция:</h5>
                    <ol class="mb-0">
                        <li>Подключите TronLink кошелек</li>
                        <li>Убедитесь, что у вас есть USDT на балансе</li>
                        <li>Введите адрес получателя и сумму</li>
                        <li>Подпишите и отправьте транзакцию</li>
                        <li>Монеты будут отправлены в блокчейн</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- TronSign Component (hidden, used only for logic) -->
        <tron-sign 
            ref="tronSign"
            @connected="onConnected"
            @disconnected="onDisconnected"
            @signing="onSigning"
            @signed="onSigned"
            @error="onError"
        ></tron-sign>

        <!-- UI Card -->
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-coins me-2"></i>
                    Подпись транзакции USDT (TRC-20)
                </h4>
            </div>
            <div class="card-body">
                <!-- Status Message -->
                <div v-if="statusVisible" :class="'alert alert-' + (statusType === 'error' ? 'danger' : statusType === 'success' ? 'success' : 'info')" role="alert">
                    [[ statusMessage ]]
                </div>
                
                <!-- Wallet Connection -->
                <div v-if="!isConnected" class="mb-4">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>TronLink не подключен</h6>
                        <p class="mb-3">Подключите TronLink для подписи транзакций</p>
                        <button 
                            class="btn btn-primary"
                            @click="connectWallet"
                            :disabled="isConnecting"
                        >
                            <span v-if="isConnecting" class="spinner-border spinner-border-sm me-2"></span>
                            <i v-else class="fas fa-plug me-2"></i>
                            [[ isConnecting ? 'Подключение...' : 'Подключить TronLink' ]]
                        </button>
                    </div>
                </div>
                
                <!-- Connected State -->
                <div v-else>
                    <!-- Wallet Info -->
                    <div class="alert alert-success mb-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Подключено:</strong>
                                <code class="ms-2">[[ shortAddress ]]</code>
                            </div>
                            <button 
                                class="btn btn-sm btn-outline-success"
                                @click="copyToClipboard(walletAddress)"
                                title="Копировать адрес"
                            >
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="mt-2">
                            <small>Полный адрес: <code>[[ walletAddress ]]</code></small>
                        </div>
                        <div class="mt-2">
                            <button 
                                class="btn btn-sm btn-outline-secondary"
                                @click="disconnectWallet"
                            >
                                <i class="fas fa-sign-out-alt me-1"></i>
                                Отключить
                            </button>
                        </div>
                    </div>
                    
                    <!-- Transaction Form -->
                    <div class="mb-4">
                        <h5 class="mb-3">Перевод USDT</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-user me-2"></i>
                                Адрес получателя
                            </label>
                            <input 
                                type="text" 
                                class="form-control"
                                v-model="recipientAddress"
                                placeholder="TRecipientAddress..."
                                :disabled="isSigning || isBroadcasting"
                            />
                            <small class="form-text text-muted">
                                TRON адрес получателя (34 символа, начинается с 'T')
                            </small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-coins me-2"></i>
                                Сумма (USDT)
                            </label>
                            <input 
                                type="number" 
                                class="form-control"
                                v-model="amount"
                                placeholder="1.0"
                                step="0.000001"
                                min="0.000001"
                                :disabled="isSigning || isBroadcasting"
                            />
                            <small class="form-text text-muted">
                                1 USDT = 1,000,000 smallest units
                            </small>
                        </div>
                        
                        <button 
                            class="btn btn-primary btn-lg w-100"
                            @click="createAndSignTransaction"
                            :disabled="!isFormValid || isSigning || isBroadcasting"
                        >
                            <span v-if="isSigning" class="spinner-border spinner-border-sm me-2"></span>
                            <span v-else-if="isBroadcasting" class="spinner-border spinner-border-sm me-2"></span>
                            <i v-else class="fas fa-paper-plane me-2"></i>
                            [[ isSigning ? 'Подписание...' : isBroadcasting ? 'Отправка...' : 'Подписать и отправить' ]]
                        </button>
                    </div>
                    
                    <!-- Transaction Result -->
                    <div v-if="transactionResult" class="mt-4">
                        <div :class="'alert alert-' + (transactionResult.success ? 'success' : 'danger')">
                            <h6>
                                <i :class="transactionResult.success ? 'fas fa-check-circle' : 'fas fa-times-circle'" class="me-2"></i>
                                [[ transactionResult.message ]]
                            </h6>
                            <div v-if="transactionResult.success && transactionResult.txId" class="mt-3">
                                <p class="mb-2"><strong>TX ID:</strong></p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <code class="small">[[ transactionResult.txId ]]</code>
                                    <button 
                                        class="btn btn-sm btn-outline-primary ms-2"
                                        @click="copyToClipboard(transactionResult.txId)"
                                        title="Копировать TX ID"
                                    >
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                                <div class="mt-3">
                                    <a 
                                        :href="getTronScanUrl(transactionResult.txId)"
                                        target="_blank"
                                        class="btn btn-primary"
                                    >
                                        <i class="fas fa-external-link-alt me-2"></i>
                                        Посмотреть в TronScan
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/vue.min.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    // Wallet state (synced with TronSign component)
                    walletAddress: null,
                    isConnected: false,
                    isConnecting: false,
                    
                    // Transaction form
                    recipientAddress: '',
                    amount: '',
                    
                    // Transaction state
                    isSigning: false,
                    isBroadcasting: false,
                    transactionResult: null,
                    
                    // UI state
                    statusMessage: '',
                    statusType: 'info',
                    statusVisible: false,
                    
                    // USDT contract address (Mainnet)
                    usdtContract: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t',
                    usdtDecimals: 6
                };
            },
            computed: {
                shortAddress() {
                    if (!this.walletAddress) return '';
                    return `${this.walletAddress.slice(0, 6)}...${this.walletAddress.slice(-4)}`;
                },
                isFormValid() {
                    return this.recipientAddress && 
                           this.recipientAddress.trim().length === 34 &&
                           this.recipientAddress.startsWith('T') &&
                           this.amount && 
                           parseFloat(this.amount) > 0;
                }
            },
            methods: {
                showStatus(message, type = 'info') {
                    this.statusMessage = message;
                    this.statusType = type;
                    this.statusVisible = true;
                    
                    if (type === 'success') {
                        setTimeout(() => {
                            this.statusVisible = false;
                        }, 5000);
                    }
                },
                
                hideStatus() {
                    this.statusVisible = false;
                },
                
                async connectWallet() {
                    try {
                        await this.$refs.tronSign.connectWallet();
                    } catch (error) {
                        // Error already emitted by component
                    }
                },
                
                disconnectWallet() {
                    this.$refs.tronSign.disconnect();
                },
                
                onConnected(data) {
                    this.walletAddress = data.address;
                    this.isConnected = true;
                    this.showStatus('Кошелек подключен', 'success');
                },
                
                onDisconnected() {
                    this.walletAddress = null;
                    this.isConnected = false;
                    this.showStatus('Кошелек отключен', 'info');
                },
                
                onSigning(data) {
                    this.isSigning = true;
                    this.showStatus('Подписание транзакции через TronLink...', 'info');
                },
                
                async onSigned(data) {
                    this.isSigning = false;
                    this.showStatus('Транзакция подписана. Отправка в блокчейн...', 'info');
                    
                    // Broadcast транзакции
                    try {
                        this.isBroadcasting = true;
                        
                        const broadcastResponse = await fetch('/api/wallets/broadcast-usdt-transaction', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                signed_transaction: data.signedTransaction
                            })
                        });
                        
                        if (!broadcastResponse.ok) {
                            let errorMessage = 'Ошибка отправки транзакции';
                            try {
                                const errorData = await broadcastResponse.json();
                                errorMessage = errorData.detail || errorData.message || errorMessage;
                            } catch (parseError) {
                                errorMessage = `Ошибка ${broadcastResponse.status}: ${broadcastResponse.statusText || 'Ошибка отправки транзакции'}`;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const broadcastData = await broadcastResponse.json();
                        
                        if (broadcastData.success && broadcastData.result) {
                            this.transactionResult = {
                                success: true,
                                txId: broadcastData.txid || data.txId,
                                message: 'Транзакция успешно отправлена!'
                            };
                            this.showStatus('Транзакция успешно отправлена!', 'success');
                            
                            // Reset form
                            this.recipientAddress = '';
                            this.amount = '';
                        } else {
                            throw new Error(broadcastData.message || 'Ошибка отправки транзакции');
                        }
                    } catch (error) {
                        const errorMessage = error.message || 'Ошибка отправки транзакции';
                        this.transactionResult = {
                            success: false,
                            message: errorMessage
                        };
                        this.showStatus('Ошибка: ' + errorMessage, 'error');
                    } finally {
                        this.isBroadcasting = false;
                    }
                },
                
                onError(data) {
                    this.isSigning = false;
                    this.isBroadcasting = false;
                    
                    const errorMessage = data.message || 'Произошла ошибка';
                    this.transactionResult = {
                        success: false,
                        message: errorMessage
                    };
                    
                    // Показываем соответствующее сообщение в UI
                    const errorLower = errorMessage.toLowerCase();
                    if (errorLower.includes('declined') || errorLower.includes('rejected') || errorLower.includes('отклонен')) {
                        this.showStatus('Подпись транзакции отклонена пользователем', 'error');
                    } else if (errorLower.includes('insufficient') || errorLower.includes('недостаточно')) {
                        this.showStatus('Недостаточно средств для выполнения транзакции', 'error');
                    } else if (errorLower.includes('revert') || errorLower.includes('откат')) {
                        this.showStatus('Транзакция откатилась: ' + errorMessage, 'error');
                    } else {
                        this.showStatus('Ошибка: ' + errorMessage, 'error');
                    }
                },
                
                async createAndSignTransaction() {
                    if (!this.isConnected) {
                        this.showStatus('Сначала подключите кошелек', 'error');
                        return;
                    }
                    
                    if (!this.isFormValid) {
                        this.showStatus('Заполните все поля корректно', 'error');
                        return;
                    }
                    
                    this.transactionResult = null;
                    this.hideStatus();
                    
                    try {
                        // Step 1: Create transaction on backend
                        this.showStatus('Создание транзакции USDT на сервере...', 'info');
                        
                        const createResponse = await fetch('/api/wallets/create-usdt-transaction', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                from_address: this.walletAddress,
                                to_address: this.recipientAddress.trim(),
                                amount: parseFloat(this.amount),
                                contract_address: this.usdtContract
                            })
                        });
                        
                        if (!createResponse.ok) {
                            let errorMessage = 'Ошибка создания транзакции';
                            try {
                                const errorData = await createResponse.json();
                                errorMessage = errorData.detail || errorData.message || errorMessage;
                            } catch (parseError) {
                                errorMessage = `Ошибка ${createResponse.status}: ${createResponse.statusText || 'Ошибка создания транзакции'}`;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const createData = await createResponse.json();
                        
                        if (!createData.success || !createData.unsigned_transaction) {
                            throw new Error('Неверный формат ответа от сервера');
                        }
                        
                        // Step 2: Sign transaction via TronSign component
                        await this.$refs.tronSign.signTransaction(createData.unsigned_transaction);
                        
                    } catch (error) {
                        // Error already handled by component events or here
                        if (!this.transactionResult) {
                            const errorMessage = error.message || 'Ошибка выполнения транзакции';
                            this.transactionResult = {
                                success: false,
                                message: errorMessage
                            };
                            this.showStatus('Ошибка: ' + errorMessage, 'error');
                        }
                    }
                },
                
                getTronScanUrl(txId) {
                    if (!txId) return '#';
                    return `https://tronscan.org/#/transaction/${txId}`;
                },
                
                copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        this.showStatus('Скопировано в буфер обмена', 'success');
                    }).catch(err => {
                        console.error('Copy error:', err);
                    });
                }
            }
        });
    </script>
</body>
</html>

